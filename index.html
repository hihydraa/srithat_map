<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>KC Map ‚Äî MT-58 / MT-60 / ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç + ‡∏™‡∏≤‡∏Ç‡∏≤ (Fixed v3 ‚Ä¢ single-select)</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    :root{
      --blue:#1666d6; --red:#ef4444; --orange:#f59e0b; --card:#ffffff; --muted:#6b7280; --ring:0 0 0 3px rgb(22 102 214 / .18);
      --bg: #f6f8fb; --text:#111827;
    }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--text); }
    #map { height: 100vh; width: 100vw; }

    /* === Focus Area Info Card === */
    .focus-box .stats { display:flex; flex-wrap:wrap; gap:8px; margin:6px 0; }
    .focus-box .mini { width:100%; border-collapse:collapse; font-size:12px; margin-top:6px; }
    .focus-box .mini th, .focus-box .mini td { border:1px solid #e5e7eb; padding:6px 8px; }
    .focus-box .mini thead th { background:#f9fafb; font-weight:600; }
    .focus-box .mini td:last-child, .focus-box .mini th:last-child { text-align:right; }

    /* Floating controls */
    .ctrl{position:absolute; z-index:1000; top:14px; right:14px; display:flex; flex-direction:column; gap:10px}
    .box{background:var(--card); border:1px solid #e5e7eb; border-radius:14px; padding:12px; box-shadow:0 8px 24px rgba(0,0,0,.08);}
    .box h3{margin:0 0 8px; font-size:14px}
    .btn{appearance:none; border:1px solid #e5e7eb; padding:7px 10px; border-radius:10px; font-size:13px; background:#f9fafb; cursor:pointer}
    .btn:focus{outline:none; box-shadow:var(--ring)}
    .btn.small{font-size:12px; padding:6px 8px}
    .pill{display:inline-flex; align-items:center; gap:6px; background:#f3f4f6; border:1px solid #e5e7eb; color:#111827; font-weight:600; padding:6px 10px; border-radius:999px; font-size:12px}

    /* Section list */
    .section{border:1px dashed #e5e7eb; border-radius:12px; padding:8px 10px; background:#fafafa; margin-top:8px; max-height:260px; overflow:auto}
    .section .head{display:flex; justify-content:space-between; align-items:center; margin:6px 0}
    .row{display:flex; align-items:center; gap:8px; margin:4px 0; font-size:13px}
    .dot{width:10px; height:10px; border-radius:999px; display:inline-block; border:1px solid #e5e7eb}
    .lbl{background:#fff !important; color:#111827 !important; border:1px solid #e5e7eb; padding:3px 6px !important; border-radius:8px !important; box-shadow:0 4px 12px rgba(0,0,0,.08)}

    /* Small helper tips */
    .tip{position:absolute; z-index:1000; left:14px; top:14px; background:#ffffff; border:1px solid #e5e7eb; border-radius:12px; padding:6px 8px; box-shadow:0 4px 12px rgba(0,0,0,.06); font-size:12px; color:#374151}

    /* Legend */
    .legend{position:absolute; z-index:1000; left:14px; bottom:14px; background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:10px 12px; box-shadow:0 8px 24px rgba(0,0,0,.08); font-size:13px}
    .legend .row{display:flex; align-items:center; gap:8px; margin:4px 0}
  </style>
</head>
<body>
  <div id="map"></div>

  <!-- Floating: helper tip -->
  <div class="tip">üìå ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>

  <!-- Floating: filters & status -->
  <div class="ctrl">
    <div class="box" style="min-width:340px">
      <h3>üéöÔ∏è ‡∏Å‡∏£‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏• (‡πÅ‡∏¢‡∏Å Section)</h3>
      <div class="row" style="gap:6px; margin-bottom:6px">
        <button class="btn small" id="btnAllOn">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <button class="btn small" id="btnAllOff">‡∏ã‡πà‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
        <span class="pill"><span id="countMarkers">0</span> ‡∏à‡∏∏‡∏î ‚Ä¢ <span id="countCircles">0</span> ‡∏ß‡∏á‡∏£‡∏±‡∏®‡∏°‡∏µ</span>
      </div>
      <div id="sections"></div>
    </div>

    <!-- ‚úÖ Focus Area Info: ‡∏ß‡∏≤‡∏á‡∏ö‡∏•‡πá‡∏≠‡∏Å‡∏ô‡∏µ‡πâ‡∏ï‡πà‡∏≠‡∏à‡∏≤‡∏Å‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏ü‡∏¥‡∏•‡πÄ‡∏ï‡∏≠‡∏£‡πå -->
    <div class="box focus-box" style="min-width:340px">
      <h3>üìç ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà‡πÇ‡∏ü‡∏Å‡∏±‡∏™</h3>

      <div class="stats">
        <span class="pill">‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏Å‡∏£ 23,500 ‡∏Ñ‡∏ô</span>
        <span class="pill">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 17/20</span>
      </div>
      <div class="stats">
        <span class="pill">‡∏û‡∏∑‡∏ä‡πÑ‡∏£‡πà‡∏£‡∏ß‡∏° 161,600 ‡πÑ‡∏£‡πà</span>
        <span class="pill">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1/20</span>
      </div>

      <table class="mini">
        <thead>
          <tr><th>‡∏û‡∏∑‡∏ä</th><th>‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (‡πÑ‡∏£‡πà)</th></tr>
        </thead>
        <tbody>
          <tr><td>‡∏°‡∏±‡∏ô‡∏™‡∏≥‡∏õ‡∏∞‡∏´‡∏•‡∏±‡∏á</td><td>69,915</td></tr>
          <tr><td>‡∏≠‡πâ‡∏≠‡∏¢</td><td>91,696</td></tr>
        </tbody>
      </table>
    </div>
    <!-- /Focus Area Info -->
  </div>

  <!-- Floating: legend -->
  <div class="legend">
    <div style="font-weight:600; margin-bottom:4px">‡∏™‡∏±‡∏ç‡∏•‡∏±‡∏Å‡∏©‡∏ì‡πå</div>
    <div class="row"><span class="dot" style="background:var(--blue)"></span> ‡∏´‡∏°‡∏∏‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° MT-58</div>
    <div class="row"><span class="dot" style="background:var(--red)"></span> ‡∏´‡∏°‡∏∏‡∏î‡∏Å‡∏•‡∏∏‡πà‡∏° MT-60</div>
    <div class="row"><span class="dot" style="background:var(--orange)"></span> ‚≠ê ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</div>
    <div class="row"><span class="dot" style="background:#8b5cf6"></span> ‡∏™‡∏≤‡∏Ç‡∏≤ (‡∏£‡∏±‡∏®‡∏°‡∏µ 100 ‡∏Å‡∏°.)</div>
    <div class="row"><span class="dot" style="background:#999"></span> ‡∏à‡∏∏‡∏î‡∏≠‡∏∑‡πà‡∏ô‡πÜ</div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ===== Map base =====
    const INITIAL_CENTER = [16.40075, 103.36453];
    const map = L.map('map', { center: INITIAL_CENTER, zoom: 8, preferCanvas: true });
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap contributors' }).addTo(map);
    const markersLayer = L.layerGroup().addTo(map);
    const circlesLayer = L.layerGroup().addTo(map);
    L.control.scale({ metric: true, imperial: false, position: 'bottomleft' }).addTo(map);

    // ===== Helper =====
    const fmtNum = (n) => Number.isFinite(n) ? Number(n.toFixed(6)) : n;
    const counts = { markers: 0, circles: 0 };
    const ACTIVE_KEYS = new Set();
    const KEYPOINT = (p) => `${fmtNum(p.lat)}|${fmtNum(p.lng)}|${(p.label||'').trim()}`;

    // Colored pin & star pin
    function markerIcon({color='#1666d6', shape='pin'}){
      if(shape === 'star'){
        const svg = encodeURIComponent(`
          <svg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24'>
            <path fill='${color}' stroke='white' stroke-width='1.5' d='M12 2.5l2.95 6.07 6.7.97-4.83 4.71 1.14 6.65L12 17.77 6.04 20.9l1.14-6.65L2.35 9.54l6.7-.97L12 2.5z'/>
          </svg>`);
        return L.icon({ iconUrl: `data:image/svg+xml,${svg}`, iconSize:[24,24], iconAnchor:[9,16], popupAnchor:[0,-16] });
      }
      return L.divIcon({
        html: `<div style="width:16px;height:16px;background:${color};border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:2px solid #fff;box-shadow:0 2px 6px rgba(0,0,0,.25)"></div>`,
        className: '', iconSize:[18,18], iconAnchor:[9,16], popupAnchor:[0,-16]
      });
    }

    function updateStats(){
      document.getElementById('countMarkers').textContent = counts.markers;
      document.getElementById('countCircles').textContent = counts.circles;
    }

    function addPoint({ lat, lng, label = '', radiusKm = 0, color = '#1666d6', shape='pin' }){
      lat = parseFloat(lat); lng = parseFloat(lng);
      if(!Number.isFinite(lat) || !Number.isFinite(lng)) return null;
      const marker = L.marker([lat, lng], { icon: markerIcon({color, shape}) });
      if(label){ marker.bindPopup(`<b>${label}</b>`); }
      marker.addTo(markersLayer); counts.markers++;
      let circle = null;
      if(Number.isFinite(radiusKm) && radiusKm > 0){
        circle = L.circle([lat, lng], { radius: radiusKm * 1000, color, weight: 2, fillOpacity: 0.08 }).addTo(circlesLayer);
        counts.circles++;
      }
      return { marker, circle };
    }

    function render(points){
      counts.markers = 0; counts.circles = 0;
      markersLayer.clearLayers(); circlesLayer.clearLayers();
      const bounds = [];
      (points || []).forEach(p => {
        const res = addPoint(p) || {};
        if(res.marker){ bounds.push(res.marker.getLatLng()); }
        if(res.circle){ bounds.push(res.circle.getBounds()); }
      });
      if(bounds.length){
        try{
          const all = L.latLngBounds([]);
          bounds.forEach(b => all.extend(b));
          map.fitBounds(all.pad(0.2));
        }catch(e){ /* noop */ }
      } else {
        map.setView(INITIAL_CENTER, 8);
      }
      updateStats();
    }

    function renderFiltered(){
      const pts = (PENDING_POINTS || []).filter(p => ACTIVE_KEYS.has(KEYPOINT(p)));
      render(pts);
    }

    // ===== Data: MT-58 (blue) =====
    const INIT_POINTS_MT58 = [
      { label: '‡∏õ‡∏±‡πä‡∏° ‡∏™.‡∏®‡∏¥‡∏£‡∏¥‡πÇ‡∏£‡∏à‡∏ô‡πå', lat: 16.908420738858442, lng: 103.16510454805565 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 01', lat: 16.95835220075993, lng: 103.16403320606038 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏ö‡πâ‡∏≤‡∏ô‡πÇ‡∏ô‡∏ô‡∏™‡∏≥‡∏£‡∏≤‡∏ç', lat: 16.969175646702165, lng: 102.97552550772018 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 01', lat: 17.139731764459313, lng: 102.7871870215529 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏•‡∏¥‡∏ô‡∏¥‡∏Ñ ‡∏Å‡∏ä‡∏û‡∏£', lat: 17.17394942162665, lng: 102.77467097428217 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 02', lat: 17.205307739386946, lng: 102.74922739663133 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 02', lat: 17.226327897384373, lng: 102.74389817978029 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 03', lat: 17.139718905682457, lng: 102.7840913191436 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 04', lat: 17.03908055009549, lng: 102.77099144507014 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 03', lat: 17.018547377062433, lng: 102.7735325009721 },
      { label: '‡∏™.‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°‡∏£‡∏∏‡πà‡∏á‡πÄ‡∏£‡∏∑‡∏≠‡∏á‡∏û‡∏≤‡∏ì‡∏¥‡∏ä‡∏¢‡πå', lat: 17.002855026975332, lng: 102.75822079602814 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 04', lat: 16.954208562413847, lng: 102.79938898853268 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 05', lat: 16.95408008441485, lng: 102.79782234748653 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 06', lat: 16.702131541050832, lng: 103.07963396319245 },
      { label: '‡∏≠‡∏≤‡∏ô‡∏±‡∏ô‡∏ó‡πå‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°', lat: 17.01895082380565, lng: 103.12914969106626 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 07', lat: 16.947927349769934, lng: 103.1218014582138 },
      { label: '‡πÉ‡∏ö‡∏ö‡∏∏‡∏ç ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', lat: 16.85439896751086, lng: 103.0832960075836 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 05', lat: 17.02639610472808, lng: 103.23837112461024 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏µ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏Ñ‡∏£‡∏π‡∏ï‡∏∏‡πã‡∏¢‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°', lat: 17.075464919092465, lng: 103.25009919476203 },
      { label: '‡πÅ‡∏ü‡∏°‡∏¥‡∏•‡∏µ‡πà ‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°', lat: 17.135582623982362, lng: 103.38963365286814 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 08', lat: 17.088741238033858, lng: 103.31914292628643 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 09', lat: 17.03370323026392, lng: 103.3123481722259 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 10', lat: 17.005129041425082, lng: 103.28821250218549 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 11', lat: 17.00336097650442, lng: 103.29555349868691 },
      { label: '‡πÄ‡∏Å‡∏ß‡∏•‡∏¥‡∏ô ‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', lat: 16.945032355626573, lng: 103.16581327281119 },
      { label: '‡πÄ‡∏≠‡∏Å‡∏®‡∏¥‡∏£‡∏¥‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', lat: 17.05134242297704, lng: 103.14020440830355 },
      { label: '‡∏õ‡∏±‡πä‡∏° ‡∏™.‡∏®‡∏¥‡∏£‡∏¥‡πÇ‡∏£‡∏à‡∏ô‡πå 2', lat: 17.04076053274442, lng: 103.11321980752213 },
      { label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏5 ‡∏à‡∏≠‡∏î‡∏£‡∏ñ', lat: 16.955169782364194, lng: 103.04753030424521 },
      { label: '‡∏õ‡∏±‡πâ‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡πÄ‡∏™‡∏µ‡πà‡∏¢‡πÇ‡∏´‡∏ô‡πà‡∏á‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', lat: 16.9518292332927, lng: 103.0339158964179 },
      { label: '‡∏õ.‡∏õ‡∏±‡∏î‡∏ñ‡∏≤‡∏Å‡∏¥‡∏à‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå', lat: 16.978564687341244, lng: 102.84798155296961 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 12', lat: 16.984645057598417, lng: 103.00826957997445 },
      { label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏1 ‡∏à‡∏≠‡∏î‡∏£‡∏ñ', lat: 16.994217062789055, lng: 103.01394489827595 },
      { label: '‡∏™‡∏°‡∏à‡∏¥‡∏ï‡∏£‡∏õ‡∏¥‡πÇ‡∏ï‡∏£‡πÄ‡∏•‡∏µ‡∏¢‡∏°', lat: 16.998685155553552, lng: 103.08626791406621 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏™‡∏ß‡∏ô', lat: 17.001232587667243, lng: 103.11586156058408 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 13', lat: 16.942963420854102, lng: 103.18554553194585 },
      { label: '‡πÇ‡∏ä‡∏Ñ‡∏®‡∏¥‡∏£‡∏¥', lat: 16.908835259839872, lng: 103.16762784767786 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 14', lat: 16.873158799866108, lng: 103.10926568197972 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏°‡∏∏‡∏ô 1', lat: 16.857076469749476, lng: 103.07421203593547 },
      { label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏2 ‡∏à‡∏≠‡∏î‡∏£‡∏ñ', lat: 16.845251776861826, lng: 103.07421285410867 },
      { label: '‡∏≠‡∏±‡∏°‡∏û‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', lat: 16.942832307127063, lng: 103.17916126748365 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 15', lat: 17.045156904114805, lng: 102.83667975711022 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 16', lat: 17.04694848473923, lng: 102.8299533049174 },
      { label: '‡∏≠‡∏∏‡πÑ‡∏£‡∏û‡∏£‡∏ö‡∏£‡∏¥‡∏Å‡∏≤‡∏£', lat: 17.01449906127115, lng: 102.74762434355166 },
      { label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏3 ‡∏à‡∏≠‡∏î‡∏£‡∏ñ', lat: 16.866594182119325, lng: 102.83943613034829 },
      { label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏4 ‡∏à‡∏≠‡∏î‡∏£‡∏ñ', lat: 16.928473745064164, lng: 103.1060268859432 },
      { label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏6 ‡∏à‡∏≠‡∏î‡∏£‡∏ñ', lat: 17.24062104131843, lng: 103.34620399977116 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 17', lat: 17.239774852246985, lng: 103.34939983168013 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 06', lat: 17.344960249584027, lng: 103.2860334766527 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏ö‡∏≤‡∏á‡∏à‡∏≤‡∏Å - ‡∏™‡∏´‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏Å‡∏©‡∏ï‡∏£ ‡πÑ‡∏ä‡∏¢‡∏ß‡∏≤‡∏ô', lat: 17.28986564885867, lng: 103.22383060288678 },
      { label: '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ô‡∏µ‡∏õ‡∏±‡πä‡∏°‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô 07', lat: 16.96641182041901, lng: 103.09235454065592 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏°‡∏∏‡∏ô 2', lat: 16.96922500127075, lng: 102.96085638475539 },
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏¢‡∏≠‡∏î‡πÄ‡∏´‡∏£‡∏µ‡∏¢‡∏ç 18', lat: 16.744026462499523, lng: 103.11037062585359 },
      { label: '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏7 ‡∏à‡∏≠‡∏î‡∏£‡∏ñ', lat: 16.75339666113845, lng: 103.08870536418858 }
    ].map(p => ({ ...p, radiusKm: 0, color: '#1666d6', group: 'MT-58', shape: 'pin' }));

    // ===== Data: MT-60 (red) =====
    const INIT_POINTS_MT60 = [
      /* ... ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• MT-60 (‡πÅ‡∏î‡∏á) ‡∏ï‡∏≤‡∏°‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤ ... */
      { label: '‡∏õ‡∏±‡πä‡∏°‡∏´‡∏°‡∏∏‡∏ô 22', lat: 16.74226816333035, lng: 102.7800321986354 }
    ].map(p => ({ ...p, radiusKm: 0, color: '#ef4444', group: 'MT-60', shape: 'pin' }));

    // ===== ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (star orange) =====
    const IMPORTANT_FACTORY = [
      /* ... ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô ... */
      { lat: 16.973343342384563, lng: 103.22787632871677, label: '‡∏™.‡πÄ‡∏à‡∏£‡∏¥‡∏ç‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤' }
    ].map(p => ({ ...p, radiusKm:0, color:'#f59e0b', group:'‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô', shape:'star' }));

    const IMPORTANT_GOV = [
      /* ... ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£ ... */
      { lat: 17.05524125875341, lng: 103.12309384214132, label: '‡∏≠‡∏ö‡∏ï.‡∏ï‡∏≤‡∏î‡∏ó‡∏≠‡∏á' }
    ].map(p => ({ ...p, radiusKm:0, color:'#f59e0b', group:'‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£', shape:'star' }));

    const IMPORTANT_SCHOOL = [
      /* ... ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ... */
      { lat: 16.954080217579445, lng: 103.3435470662569, label: '‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô‡∏´‡∏ô‡∏≠‡∏á‡∏´‡∏ç‡πâ‡∏≤‡πÑ‡∏ã' }
    ].map(p => ({ ...p, radiusKm:0, color:'#f59e0b', group:'‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', shape:'star' }));

    // ===== ‡∏™‡∏≤‡∏Ç‡∏≤ (Branches) =====
    const BRANCHES = [
      { label: 'ST (‡∏®‡∏£‡∏µ‡∏ò‡∏≤‡∏ï‡∏∏)', lat: 16.381077857535082, lng: 103.34878306123511, radiusKm: 100 },
      { label: 'WNN (‡∏ß‡∏≤‡∏ô‡∏£‡∏ô‡∏¥‡∏ß‡∏≤‡∏™)', lat: 17.629310454083484, lng: 103.76762092529806, radiusKm: 100 },
      { label: 'KN (‡∏Å‡∏±‡∏ô‡∏ó‡∏£‡∏ß‡∏¥‡∏ä‡∏±‡∏¢)', lat: 16.716003911503602, lng: 103.08204680424339, radiusKm: 100 },
      { label: 'MUK (‡∏°‡∏∏‡∏Å‡∏î‡∏≤‡∏´‡∏≤‡∏£)', lat: 16.715997069768893, lng: 103.08204553963455, radiusKm: 100 }
    ].map(p => ({ ...p, color: '#8b5cf6', group: '‡∏™‡∏≤‡∏Ç‡∏≤', shape: 'pin' }));

    // ===== Others =====
    const SPECIALS = [
      { label: 'PT ‡∏®‡∏£‡∏µ‡∏ò‡∏≤‡∏ï‡∏∏', lat: 16.967218892333054, lng: 103.27321383932237, radiusKm: 100, color: '#FFFF00', group: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', shape:'pin' }
    ];

    // ===== State & storage =====
    const STORAGE_KEY = 'kc_map_mt5860_overlay_v30_single';
    let PENDING_POINTS = [];
    try{
      const saved = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
      if(Array.isArray(saved)) PENDING_POINTS = saved;
    }catch(e){ /* ignore */ }

    function dedupeAppend(points){
      const key = (p) => `${fmtNum(p.lat)}|${fmtNum(p.lng)}|${(p.label||'').trim()}`;
      const mapByKey = new Map(PENDING_POINTS.map(p => [key(p), p]));
      points.forEach(p => mapByKey.set(key(p), p));
      PENDING_POINTS = Array.from(mapByKey.values());
      localStorage.setItem(STORAGE_KEY, JSON.stringify(PENDING_POINTS));
    }

    // ===== Build dynamic sections =====
    function buildSections(){
      const container = document.getElementById('sections');
      container.innerHTML = '';

      // Group points
      const groups = {};
      (PENDING_POINTS||[]).forEach(p => { (groups[p.group] = groups[p.group] || []).push(p); });

      const order = ['MT-58','MT-60','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô','‡∏™‡∏≤‡∏Ç‡∏≤','‡∏≠‡∏∑‡πà‡∏ô‡πÜ'];
      const colorHint = {
        'MT-58': 'var(--blue)',
        'MT-60': 'var(--red)',
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô': 'var(--orange)',
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£': 'var(--orange)',
        '‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô': 'var(--orange)',
        '‡∏™‡∏≤‡∏Ç‡∏≤': '#8b5cf6',
        '‡∏≠‡∏∑‡πà‡∏ô‡πÜ': '#999'
      };
      const COMPACT_GROUPS = new Set(['MT-58','MT-60','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡∏á‡∏≤‡∏ô','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡∏≤‡∏ä‡∏Å‡∏≤‡∏£','‡∏™‡∏ñ‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç: ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']);
      const SINGLE_SELECT = new Set(['‡∏≠‡∏∑‡πà‡∏ô‡πÜ']);

      [...order, ...Object.keys(groups).filter(g => !order.includes(g))].forEach(g => {
        if(!groups[g]) return;
        const isCompact = COMPACT_GROUPS.has(g);
        const sec = document.createElement('div'); sec.className = 'section';
        sec.innerHTML = `
          <div class="head">
            <div><b>${g}</b> <span class="dot" style="background:${colorHint[g]||'#999'}"></span></div>
            <div>
              <button class="btn small" data-gselect="on"  data-group="${g}">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
              <button class="btn small" data-gselect="off" data-group="${g}">‡∏ã‡πà‡∏≠‡∏ô‡∏Å‡∏•‡∏∏‡πà‡∏°</button>
            </div>
          </div>
          ${isCompact ? '' : `<div class="list" data-group-list="${g}"></div>`}
        `;
        container.appendChild(sec);

        if(isCompact){
          (groups[g]||[]).forEach(p => { const k = KEYPOINT(p); if(!ACTIVE_KEYS.has(k)) ACTIVE_KEYS.add(k); });
        }
      });

      // Fill items for non-compact: '‡∏™‡∏≤‡∏Ç‡∏≤', '‡∏≠‡∏∑‡πà‡∏ô‡πÜ'
      Object.entries(groups).forEach(([g, items]) => {
        if(COMPACT_GROUPS.has(g)) return;
        const wrap = container.querySelector(`[data-group-list="${g}"]`);
        if(!wrap) return; wrap.innerHTML = '';

        const isSingle = new Set(['‡∏≠‡∏∑‡πà‡∏ô‡πÜ']).has(g);
        items.forEach((p) => {
          const key = KEYPOINT(p);
          const inputType = isSingle ? 'radio' : 'checkbox';
          const nameAttr = isSingle ? `name="group-${g}"` : '';
          const row = document.createElement('label'); row.className='row';
          row.innerHTML = `<input type="${inputType}" ${nameAttr} data-key="${key}" data-group="${g}"> <span class="dot" style="background:${p.color}"></span> <span>${p.label}</span>`;
          wrap.appendChild(row);
        });
      });

      // Group-level buttons
      container.querySelectorAll('[data-group]').forEach(btn => {
        btn.addEventListener('click', () => {
          const g = btn.getAttribute('data-group');
          const turnOn = btn.getAttribute('data-gselect')==='on';
          const isCompact = COMPACT_GROUPS.has(g);
          const isSingle = SINGLE_SELECT.has(g);
          const groupItems = (groups[g]||[]);

          if(isCompact){
            groupItems.forEach(p => {
              const k = KEYPOINT(p);
              if(turnOn) ACTIVE_KEYS.add(k); else ACTIVE_KEYS.delete(k);
            });
          }else{
            const inputs = Array.from(document.querySelectorAll(`input[data-group="${g}"]`));
            if(isSingle){
              if(turnOn && inputs.length){
                inputs.forEach(i => { i.checked = false; });
                const first = inputs[0];
                first.checked = true;
                groupItems.forEach(p => ACTIVE_KEYS.delete(KEYPOINT(p)));
                ACTIVE_KEYS.add(first.getAttribute('data-key'));
              }else{
                inputs.forEach(i => i.checked = false);
                groupItems.forEach(p => ACTIVE_KEYS.delete(KEYPOINT(p)));
              }
            }else{
              inputs.forEach(cb => {
                cb.checked = turnOn;
                const k = cb.getAttribute('data-key');
                if(turnOn) ACTIVE_KEYS.add(k); else ACTIVE_KEYS.delete(k);
              });
            }
          }
          renderFiltered();
        });
      });

      // Per-item change (radio/checkbox)
      container.addEventListener('change', (e)=>{
        const t = e.target;
        if(!(t && (t.matches('input[type="radio"]') || t.matches('input[type="checkbox"]')))) return;
        const g = t.getAttribute('data-group');
        const key = t.getAttribute('data-key');
        const isSingle = SINGLE_SELECT.has(g);
        if(isSingle){
          container.querySelectorAll(`input[data-group="${g}"]`).forEach(i => { if(i!==t) i.checked = false; });
          (groups[g]||[]).forEach(p => ACTIVE_KEYS.delete(KEYPOINT(p)));
          if(t.checked){ ACTIVE_KEYS.add(key); }
        }else{
          if(t.checked) ACTIVE_KEYS.add(key); else ACTIVE_KEYS.delete(key);
        }
        renderFiltered();
      });
    }

    // Global select
    document.getElementById('btnAllOn').addEventListener('click', ()=>{
      ACTIVE_KEYS.clear();
      (PENDING_POINTS||[]).forEach(p => {
        if(p.group==='‡∏™‡∏≤‡∏Ç‡∏≤' || p.group==='‡∏≠‡∏∑‡πà‡∏ô‡πÜ') return;
        ACTIVE_KEYS.add(KEYPOINT(p));
      });
      document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(i => {
        const g = i.getAttribute('data-group');
        if(g==='‡∏™‡∏≤‡∏Ç‡∏≤' || g==='‡∏≠‡∏∑‡πà‡∏ô‡πÜ'){ i.checked = false; } else { i.checked = true; }
      });
      renderFiltered();
    });
    document.getElementById('btnAllOff').addEventListener('click', ()=>{
      ACTIVE_KEYS.clear();
      document.querySelectorAll('input[type="radio"], input[type="checkbox"]').forEach(i => i.checked = false);
      renderFiltered();
    });

    // Copy lat/lng on click
    map.on('click', async (e) => {
      const s = `${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}`; try{ await navigator.clipboard.writeText(s);}catch(_){ }
    });

    // Init
    dedupeAppend([
      ...INIT_POINTS_MT58,
      ...INIT_POINTS_MT60,
      ...IMPORTANT_FACTORY,
      ...IMPORTANT_GOV,
      ...IMPORTANT_SCHOOL,
      ...BRANCHES,
      ...SPECIALS
    ]);
    (PENDING_POINTS||[]).forEach(p => {
      if(p.group!=='‡∏™‡∏≤‡∏Ç‡∏≤' && p.group!=='‡∏≠‡∏∑‡πà‡∏ô‡πÜ'){ ACTIVE_KEYS.add(KEYPOINT(p)); }
    });
    buildSections();
    renderFiltered();
  </script>
</body>
</html>
